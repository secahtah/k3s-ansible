---
# tasks file for common

- name: Update all packages
  ansible.builtin.yum:
    name: '*'
    state: latest
  register: yumcommandout
  become: true
- name: Fail if yum can't upgrade
  fail:
    msg: "yum command produced errors"
  when: yumcommandout is not defined

- name: Install missing packages
  ansible.builtin.yum:
    name: 
      - epel-release 
      - jq 
      - rsync 
      - tree 
      - iptables-utils 
      - nfs-utils
    state: present
  become: true
  
- name: Fail if yum can't install required packages
  fail:
    msg: "yum command produced errors"
  when: yumcommandout is not defined

- name: check to see if we need a reboot
  command: needs-restarting -r
  register: result
  ignore_errors: yes
  become: true
  
- name: Reboot Server if Necessary
  command: shutdown -r now "Ansible Updates Triggered"
  become: true
  async: 60
  poll: 0
  when: result.rc == 1

- name: Create directory to mount NFS
  ansible.builtin.file:
    path: "{{ nfspath }}"
    state: directory
    mode: '0755'
  become: true

- name: Add NFS Mount point if doesn't exist to /etc/fstab
  ansible.builtin.lineinfile:
    path: /etc/fstab
    insertafter: EOF
    line: '{{ nfshostname }}:{{ nfsexportpath }}   {{ nfsmountpath }}   nfs   defaults 0 0'
  become: true

- name: Mount the new file system
# mount /mnt/nfs
  ansible.builtin.mount:
    path: "{{ nfsmountpath }}"
    state: mounted
  become: true

- name: Touch a file to ensure that we can write to it
# touch /mnt/nfs/your-mom
  ansible.builtin.file:
    path: "{{ nfsmountpath }}/your-mom"
    state: touch